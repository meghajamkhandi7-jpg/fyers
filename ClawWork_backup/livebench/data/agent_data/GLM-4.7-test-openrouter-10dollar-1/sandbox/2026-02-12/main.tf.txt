terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
  required_version = ">= 1.0"
}

provider "aws" {
  region = var.aws_region
}

# ============================================================================
# DATA SOURCES
# ============================================================================

data "aws_caller_identity" "current" {}
data "aws_region" "current" {}

# ============================================================================
# IAM ROLE FOR LAMBDA
# ============================================================================

data "aws_iam_policy_document" "lambda_assume_role" {
  statement {
    effect = "Allow"
    principals {
      type        = "Service"
      identifiers = ["lambda.amazonaws.com"]
    }
    actions = ["sts:AssumeRole"]
  }
}

resource "aws_iam_role" "lambda_role" {
  name               = "${var.lambda_function_name}-role"
  description        = "IAM role for contact form Lambda function"
  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role.json
  
  tags = var.tags
}

data "aws_iam_policy_document" "lambda_policy" {
  statement {
    sid    = "AllowSESSendEmail"
    effect = "Allow"
    actions = [
      "ses:SendEmail",
      "ses:SendTemplatedEmail"
    ]
    resources = [
      aws_ses_email_identity.primary_recipient.arn,
      aws_ses_email_identity.admin_recipient.arn,
      aws_ses_domain_identity.domain.arn
    ]
  }
  
  statement {
    sid    = "AllowCloudWatchLogs"
    effect = "Allow"
    actions = [
      "logs:CreateLogGroup",
      "logs:CreateLogStream",
      "logs:PutLogEvents"
    ]
    resources = [
      "${aws_cloudwatch_log_group.lambda.arn}:*"
    ]
  }
}

resource "aws_iam_role_policy" "lambda_policy" {
  name   = "${var.lambda_function_name}-policy"
  role   = aws_iam_role.lambda_role.id
  policy = data.aws_iam_policy_document.lambda_policy.json
}

# ============================================================================
# AMAZON SES RESOURCES
# ============================================================================

# Domain identity for sending emails
resource "aws_ses_domain_identity" "domain" {
  domain = var.domain_name
}

# DKIM verification tokens
resource "aws_ses_domain_dkim" "domain_dkim" {
  domain = aws_ses_domain_identity.domain.domain
}

# MAIL FROM domain
resource "aws_ses_domain_mail_from" "domain_mail_from" {
  domain           = aws_ses_domain_identity.domain.domain
  mail_from_domain = "mail.${var.domain_name}"
}

# Email identity for primary recipient
resource "aws_ses_email_identity" "primary_recipient" {
  email = var.primary_recipient_email
}

# Email identity for admin recipient
resource "aws_ses_email_identity" "admin_recipient" {
  email = var.admin_recipient_email
}

# SES Email Template for contact form submissions
resource "aws_ses_email_template" "contact_form" {
  name    = var.ses_template_name
  subject = "New Contact Form Submission: {{subject}}"
  html    = <<EOT
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #4a90e2; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; background-color: #f9f9f9; }
        .field { margin-bottom: 15px; }
        .label { font-weight: bold; color: #555; }
        .value { margin-top: 5px; }
        .footer { padding: 15px; text-align: center; font-size: 12px; color: #777; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>New Contact Form Submission</h1>
        </div>
        <div class="content">
            <div class="field">
                <div class="label">From:</div>
                <div class="value">{{firstName}} {{lastName}} &lt;{{senderEmail}}&gt;</div>
            </div>
            <div class="field">
                <div class="label">Subject:</div>
                <div class="value">{{subject}}</div>
            </div>
            <div class="field">
                <div class="label">Message:</div>
                <div class="value" style="white-space: pre-wrap;">{{message}}</div>
            </div>
            <div class="field">
                <div class="label">Submitted:</div>
                <div class="value">{{timestamp}}</div>
            </div>
        </div>
        <div class="footer">
            This message was sent through the contact form on {{domain}}.<br>
            Please do not reply directly to this email.
        </div>
    </div>
</body>
</html>
EOT
  text    = <<EOT
New Contact Form Submission
===========================

From: {{firstName}} {{lastName}} <{{senderEmail}}>
Subject: {{subject}}

Message:
{{message}}

Submitted: {{timestamp}}

---
This message was sent through the contact form on {{domain}}.
EOT
}

# ============================================================================
# CLOUDWATCH LOG GROUP FOR LAMBDA
# ============================================================================

resource "aws_cloudwatch_log_group" "lambda" {
  name              = "/aws/lambda/${var.lambda_function_name}"
  retention_in_days = var.log_retention_days
  
  tags = var.tags
}

# ============================================================================
# LAMBDA FUNCTION
# ============================================================================

# Archive the Lambda function
data "archive_file" "lambda" {
  type        = "zip"
  source_file = "${path.module}/exports.js"
  output_path = "${path.module}/exports.js.zip"
}

resource "aws_lambda_function" "contact_form" {
  filename         = data.archive_file.lambda.output_path
  function_name    = var.lambda_function_name
  role            = aws_iam_role.lambda_role.arn
  description     = "Process contact form submissions with reCAPTCHA validation"
  handler         = "exports.handler"
  runtime         = "nodejs18.x"
  source_code_hash = data.archive_file.lambda.output_base64sha256
  
  timeout = var.lambda_timeout
  memory_size = var.lambda_memory_size
  
  environment {
    variables = {
      SES_TEMPLATE_NAME      = var.ses_template_name
      AWS_REGION            = var.aws_region
      PRIMARY_RECIPIENT     = var.primary_recipient_email
      ADMIN_RECIPIENT       = var.admin_recipient_email
      RECAPTCHA_SECRET_KEY  = var.recaptcha_secret_key
      DOMAIN_NAME           = var.domain_name
    }
  }
  
  tags = var.tags
  
  depends_on = [
    aws_cloudwatch_log_group.lambda,
    aws_iam_role_policy.lambda_policy
  ]
}

# ============================================================================
# API GATEWAY
# ============================================================================

# REST API
resource "aws_api_gateway_rest_api" "contact_api" {
  name        = "${var.api_name}-${var.api_stage}"
  description = "API Gateway for contact form submissions"
  
  endpoint_configuration {
    types = ["REGIONAL"]
  }
  
  tags = var.tags
}

# Resource for /contact-us path
resource "aws_api_gateway_resource" "contact_us" {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  parent_id   = aws_api_gateway_rest_api.contact_api.root_resource_id
  path_part   = var.api_path
}

# Method for POST /contact-us
resource "aws_api_gateway_method" "contact_post" {
  rest_api_id   = aws_api_gateway_rest_api.contact_api.id
  resource_id   = aws_api_gateway_resource.contact_us.id
  http_method   = "POST"
  authorization = "NONE"
  
  request_parameters = {
    "method.request.header.Content-Type" = true
  }
}

# Lambda integration
resource "aws_api_gateway_integration" "contact_lambda" {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  resource_id = aws_api_gateway_resource.contact_us.id
  http_method = aws_api_gateway_method.contact_post.http_method
  
  type                    = "AWS_PROXY"
  integration_http_method = "POST"
  uri                     = aws_lambda_function.contact_form.invoke_arn
  
  request_parameters = {
    "integration.request.header.Content-Type" = "'application/json'"
  }
}

# API Gateway Lambda permission
resource "aws_lambda_permission" "api_gateway" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.contact_form.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${aws_api_gateway_rest_api.contact_api.execution_arn}/*/*${var.api_path}"
}

# Deployment
resource "aws_api_gateway_deployment" "contact_deployment" {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  
  triggers = {
    redeployment = sha1(jsonencode([
      aws_api_gateway_resource.contact_us.id,
      aws_api_gateway_method.contact_post.id,
      aws_api_gateway_integration.contact_lambda.id
    ]))
  }
  
  lifecycle {
    create_before_destroy = true
  }
  
  depends_on = [
    aws_api_gateway_method.contact_post,
    aws_api_gateway_integration.contact_lambda
  ]
}

# Stage
resource "aws_api_gateway_stage" "contact_stage" {
  deployment_id = aws_api_gateway_deployment.contact_deployment.id
  rest_api_id   = aws_api_gateway_rest_api.contact_api.id
  stage_name    = var.api_stage
  
  tags = var.tags
}

# Enable CORS (optional, for web frontend)
resource "aws_api_gateway_method" "options" {
  rest_api_id   = aws_api_gateway_rest_api.contact_api.id
  resource_id   = aws_api_gateway_resource.contact_us.id
  http_method   = "OPTIONS"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "options" {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  resource_id = aws_api_gateway_resource.contact_us.id
  http_method = aws_api_gateway_method.options.http_method
  
  type                    = "MOCK"
  integration_http_method = "OPTIONS"
  request_templates = {
    "application/json" = "{statusCode:200}"
  }
}

resource "aws_api_gateway_method_response" "options_200" {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  resource_id = aws_api_gateway_resource.contact_us.id
  http_method = aws_api_gateway_method.options.http_method
  status_code = "200"
  
  response_parameters = {
    "method.response.header.Access-Control-Allow-Headers" = true
    "method.response.header.Access-Control-Allow-Methods"  = true
    "method.response.header.Access-Control-Allow-Origin"   = true
  }
}

resource "aws_api_gateway_integration_response" "options" {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  resource_id = aws_api_gateway_resource.contact_us.id
  http_method = aws_api_gateway_method.options.http_method
  status_code = aws_api_gateway_method_response.options_200.status_code
  
  response_parameters = {
    "method.response.header.Access-Control-Allow-Headers" = "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
    "method.response.header.Access-Control-Allow-Methods"  = "'POST,OPTIONS'"
    "method.response.header.Access-Control-Allow-Origin"   = "'*'"
  }
}