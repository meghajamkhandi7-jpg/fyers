/**
 * Contact Form Lambda Handler
 * Node.js 18 with AWS SDK v3
 * 
 * Validates Google reCAPTCHA and sends emails via AWS SES
 */

const { SESClient, SendTemplatedEmailCommand } = require("@aws-sdk/client-ses");
const https = require('https');

// Environment variables
const SES_TEMPLATE_NAME = process.env.SES_TEMPLATE_NAME || 'ContactFormTemplate';
const AWS_REGION = process.env.AWS_REGION || 'us-east-1';
const PRIMARY_RECIPIENT = process.env.PRIMARY_RECIPIENT || 'primary@example.com';
const ADMIN_RECIPIENT = process.env.ADMIN_RECIPIENT || 'admin@example.com';
const RECAPTCHA_SECRET_KEY = process.env.RECAPTCHA_SECRET_KEY || 'your-secret-key';

// Initialize SES client
const sesClient = new SESClient({ region: AWS_REGION });

/**
 * Validates reCAPTCHA token with Google's API
 */
function validateRecaptcha(token) {
    return new Promise((resolve, reject) => {
        const postData = JSON.stringify({
            secret: RECAPTCHA_SECRET_KEY,
            response: token
        });

        const options = {
            hostname: 'www.google.com',
            port: 443,
            path: '/recaptcha/api/siteverify',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
            }
        };

        const req = https.request(options, (res) => {
            let data = '';

            res.on('data', (chunk) => {
                data += chunk;
            });

            res.on('end', () => {
                try {
                    const result = JSON.parse(data);
                    if (result.success) {
                        resolve(result);
                    } else {
                        reject(new Error('reCAPTCHA validation failed'));
                    }
                } catch (error) {
                    reject(new Error('Failed to parse reCAPTCHA response'));
                }
            });
        });

        req.on('error', (error) => {
            reject(new Error(`reCAPTCHA request failed: ${error.message}`));
        });

        req.write(postData);
        req.end();
    });
}

/**
 * Sends templated email via AWS SES
 */
async function sendEmail(formData) {
    const params = {
        Source: PRIMARY_RECIPIENT,
        Destination: {
            ToAddresses: [PRIMARY_RECIPIENT],
            CcAddresses: [ADMIN_RECIPIENT]
        },
        Template: SES_TEMPLATE_NAME,
        TemplateData: JSON.stringify({
            firstName: formData.firstName,
            lastName: formData.lastName,
            email: formData.email,
            subject: formData.subject,
            message: formData.message,
            timestamp: new Date().toISOString()
        }),
        ReplyToAddresses: [formData.email]
    };

    try {
        const command = new SendTemplatedEmailCommand(params);
        const result = await sesClient.send(command);
        return result;
    } catch (error) {
        console.error('SES error:', error);
        throw new Error(`Failed to send email: ${error.message}`);
    }
}

/**
 * Validates required fields in the request body
 */
function validateRequestBody(body) {
    const errors = [];
    const requiredFields = ['firstName', 'lastName', 'email', 'subject', 'message', 'reCaptchaToken'];

    for (const field of requiredFields) {
        if (!body[field] || typeof body[field] !== 'string' || body[field].trim() === '') {
            errors.push(`Missing or empty field: ${field}`);
        }
    }

    // Basic email format validation
    if (body.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(body.email)) {
        errors.push('Invalid email format');
    }

    return errors;
}

/**
 * Lambda handler
 */
exports.handler = async (event) => {
    console.log('Received event:', JSON.stringify(event, null, 2));

    try {
        // Parse request body
        let body;
        try {
            body = JSON.parse(event.body);
        } catch (error) {
            return {
                statusCode: 400,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                body: JSON.stringify({
                    message: 'Invalid JSON in request body'
                })
            };
        }

        // Validate required fields
        const validationErrors = validateRequestBody(body);
        if (validationErrors.length > 0) {
            return {
                statusCode: 400,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                body: JSON.stringify({
                    message: 'Validation failed',
                    errors: validationErrors
                })
            };
        }

        // Validate reCAPTCHA
        try {
            await validateRecaptcha(body.reCaptchaToken);
            console.log('reCAPTCHA validation successful');
        } catch (error) {
            console.error('reCAPTCHA validation error:', error);
            return {
                statusCode: 400,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                body: JSON.stringify({
                    message: 'reCAPTCHA validation failed',
                    error: error.message
                })
            };
        }

        // Send email via SES
        try {
            const emailResult = await sendEmail(body);
            console.log('Email sent successfully:', emailResult);
        } catch (error) {
            console.error('Failed to send email:', error);
            return {
                statusCode: 500,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                body: JSON.stringify({
                    message: 'Failed to send email',
                    error: error.message
                })
            };
        }

        // Success response
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                message: 'Contact form submitted successfully'
            })
        };

    } catch (error) {
        console.error('Unexpected error:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                message: 'An unexpected error occurred',
                error: error.message
            })
        };
    }
};